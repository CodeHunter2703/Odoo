<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Expense App â€“ Employee Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="login-container">
      <div class="login-title">Employee Dashboard</div>
      <form class="login-form" id="expense-form">
        <label for="amount">Amount</label>
        <input type="number" step="0.01" id="amount" required />

        <label for="currency">Currency</label>
        <input type="text" id="currency" placeholder="e.g. USD, INR" required />

        <label for="category">Category</label>
        <input type="text" id="category" required />

        <label for="description">Description</label>
        <input type="text" id="description" required />

        <label for="date">Date</label>
        <input type="date" id="date" required />

        <label for="receipt">Upload Receipt (image/pdf)</label>
        <input type="file" id="receipt" accept="image/*,application/pdf" />

        <div class="error-msg" id="expense-error"></div>
        <button type="submit" class="login-btn">Submit Expense</button>
      </form>
      <div style="width: 100%; margin-top: 2rem">
        <h3 style="color: #22223b; margin-bottom: 0.5rem; font-size: 1.13rem">
          Expense History
        </h3>
        <table
          style="width: 100%; border-collapse: collapse; font-size: 0.96rem"
        >
          <thead>
            <tr style="background: #f3f0ff">
              <th style="padding: 0.4rem 0">Amount</th>
              <th>Date</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="expense-history">
            </tbody>
        </table>
      </div>
      <a class="signup-link" href="login.html" onclick="logout()">Logout</a>
    </div>

    <script>
      // Function to convert a file to a Base64 string
      function toBase64(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.readAsDataURL(file);
          reader.onload = () => resolve(reader.result);
          reader.onerror = (error) => reject(error);
        });
      }

      document.getElementById("expense-form").onsubmit = async function (e) {
        e.preventDefault();
        const errorDiv = document.getElementById("expense-error");
        errorDiv.textContent = "";

        // --- SOLUTION: Check if user is logged in ---
        const userEmail = localStorage.getItem("userEmail");
        if (!userEmail) {
          errorDiv.textContent = "Not logged in. Please log in again to submit an expense.";
          return; // Stop the submission
        }
        // ---------------------------------------------

        // Collect form data
        const amount = document.getElementById("amount").value;
        const currency = document.getElementById("currency").value;
        const category = document.getElementById("category").value;
        const description = document.getElementById("description").value;
        const date = document.getElementById("date").value;
        const receiptFile = document.getElementById("receipt").files[5];
        
        let receiptBase64 = null;
        if (receiptFile) {
          receiptBase64 = await toBase64(receiptFile);
        }

        const expenseData = {
          user: userEmail,
          amount,
          currency,
          category,
          description,
          date,
          receipt: receiptBase64,
        };

        try {
          const res = await fetch(
            "http://localhost:5000/api/employee/submit-expense",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(expenseData),
            }
          );
          if (res.ok) {
            alert("Expense submitted!");
            document.getElementById("expense-form").reset();
            loadHistory(); // Refresh history table
          } else {
            // This is the error you were seeing
            errorDiv.textContent = "Error submitting expense. Please check all fields.";
          }
        } catch {
          errorDiv.textContent = "Server error. Could not connect to the server.";
        }
      };

      async function loadHistory() {
        const userEmail = localStorage.getItem("userEmail");
        if (!userEmail) return; // Don't try to load history if not logged in

        const res = await fetch(`http://localhost:5000/api/employee/expenses?user=${userEmail}`);
        const expenses = await res.json();
        
        const tbody = document.getElementById("expense-history");
        if (expenses.length === 0) {
            tbody.innerHTML = '<tr><td colspan="3" style="text-align:center; padding: 1rem;">No history found.</td></tr>';
            return;
        }

        tbody.innerHTML = expenses
          .map(
            (r) => `<tr>
                <td>${r.amount} ${r.currency}</td>
                <td>${new Date(r.date).toLocaleDateString()}</td>
                <td>${r.status}</td>
              </tr>`
          )
          .join("");
      }
      
      function logout() {
        localStorage.clear();
        window.location.href = 'login.html';
      }

      document.addEventListener('DOMContentLoaded', loadHistory);
    </script>
  </body>
</html>